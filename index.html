<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Concours de Pêche - Live</title>
    
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { background-color: #f3f4f6; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // CONFIGURATION FIREBASE
        const firebaseConfig = {
            apiKey: "AIzaSyB44m6DoeyQSNMctS0hKlpaPR5vNOTNsW0",
            authDomain: "concours-peche.firebaseapp.com",
            projectId: "concours-peche",
            storageBucket: "concours-peche.firebasestorage.app",
            messagingSenderId: "376446532224",
            appId: "1:376446532224:web:4f9c1ffd2f4fe3ef450465"
        };
        
        // Initialisation
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        const { useState, useEffect } = React;

        // Composant d'icône Lucide
        const Icon = ({ name, size = 24, className = "" }) => {
            useEffect(() => {
                if (window.lucide) window.lucide.createIcons();
            }, [name]);
            return <i data-lucide={name} style={{ width: size, height: size }} className={className}></i>;
        };

        const FishingContestApp = () => {
            const [currentPage, setCurrentPage] = useState('index');
            const [fishermen, setFishermen] = useState([]);
            const [contestInfo, setContestInfo] = useState({ title: 'Concours de Pêche', date: '2025' });
            const [loading, setLoading] = useState(true);

            // CONNEXION TEMPS RÉEL FIREBASE
            useEffect(() => {
                const unsub = db.collection('competition').onSnapshot(snap => {
                    snap.forEach(doc => {
                        if (doc.id === 'data') setFishermen(doc.data().list || []);
                        if (doc.id === 'settings') setContestInfo(doc.data().info || { title: 'Concours de Pêche', date: '2025' });
                    });
                    setLoading(false);
                });
                return () => unsub();
            }, []);

            // SAUVEGARDE VERS FIREBASE
            const saveToFirebase = (newList) => {
                db.collection('competition').doc('data').set({ list: newList });
            };

            const saveContestInfo = (info) => {
                setContestInfo(info);
                db.collection('competition').doc('settings').set({ info });
            };

            const addFisherman = (nom, prenom, poste) => {
                if (nom && prenom) {
                    if (poste && fishermen.find(f => f.poste === poste)) {
                        alert('Ce poste est déjà occupé !');
                        return false;
                    }
                    const newList = [...fishermen, { nom, prenom, poste: poste || null, weights: [] }];
                    saveToFirebase(newList);
                    return true;
                }
                return false;
            };

            const deleteFisherman = (index) => {
                if (window.confirm('Supprimer ce pêcheur ?')) {
                    const newList = fishermen.filter((_, idx) => idx !== index);
                    saveToFirebase(newList);
                }
            };

            const addWeight = (poste, period, weight, fishCount) => {
                const newList = fishermen.map(f => {
                    if (f.poste === poste) {
                        return { 
                            ...f, 
                            weights: [...(f.weights || []), { 
                                period, 
                                weight: parseFloat(weight) || 0, 
                                fishCount: parseInt(fishCount) || 1,
                                time: new Date().toISOString() 
                            }] 
                        };
                    }
                    return f;
                });
                saveToFirebase(newList);
            };

            const deleteWeight = (poste, index) => {
                const newList = fishermen.map(f => {
                    if (f.poste === poste) {
                        const weights = [...(f.weights || [])];
                        weights.splice(index, 1);
                        return { ...f, weights };
                    }
                    return f;
                });
                saveToFirebase(newList);
            };

            const getTotalWeight = (f) => f.weights ? f.weights.reduce((sum, w) => sum + w.weight, 0) : 0;
            const getTotalFishCount = (f) => f.weights ? f.weights.reduce((sum, w) => sum + (w.fishCount || 0), 0) : 0;
            const getWeightByPeriod = (f, p) => f.weights ? f.weights.filter(w => w.period === p).reduce((sum, w) => sum + w.weight, 0) : 0;

            if (loading) return <div className="h-screen flex items-center justify-center font-bold">Synchronisation Firebase...</div>;

            // --- VUES (Exactement comme dans ton testprog.html) ---

            const IndexPage = () => (
                <div className="min-h-screen p-4">
                    <div className="flex justify-end mb-4">
                        <button onClick={() => setCurrentPage('settings')} className="bg-gray-600 text-white p-3 rounded-full shadow-lg">
                            <Icon name="settings" />
                        </button>
                    </div>
                    <h1 className="text-3xl font-bold text-center mb-2 text-blue-900">{contestInfo.title}</h1>
                    <h2 className="text-xl text-center mb-8 text-gray-700">{contestInfo.date}</h2>
                    <div className="max-w-2xl mx-auto grid grid-cols-2 gap-4">
                        <button onClick={() => setCurrentPage('inscription')} className="bg-orange-500 text-white font-bold py-6 px-4 rounded-lg shadow-lg">
                            <Icon name="users" className="mx-auto mb-2" /> Inscription
                        </button>
                        <button onClick={() => setCurrentPage('resultats')} className="bg-green-500 text-white font-bold py-6 px-4 rounded-lg shadow-lg">
                            <Icon name="trophy" className="mx-auto mb-2" /> Résultats
                        </button>
                        {[1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14].map(num => {
                            const f = fishermen.find(p => p.poste === num.toString());
                            return (
                                <button key={num} onClick={() => setCurrentPage(`poste${num}`)} 
                                    className={`${f ? 'bg-blue-600 text-white' : 'bg-white text-blue-900'} border font-semibold py-4 px-4 rounded-lg shadow`}>
                                    Poste {num} {f && `(${f.nom})`}
                                </button>
                            );
                        })}
                    </div>
                </div>
            );

            const InscriptionPage = () => {
                const [form, setForm] = useState({ nom: '', prenom: '', poste: '' });
                return (
                    <div className="min-h-screen p-4">
                        <button onClick={() => setCurrentPage('index')} className="mb-4 flex items-center text-blue-600"><Icon name="arrow-left" size={20} className="mr-2" /> Retour</button>
                        <h1 className="text-2xl font-bold mb-6">Inscription</h1>
                        <div className="bg-white p-6 rounded-lg shadow mb-6">
                            <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                                <input placeholder="Nom" value={form.nom} onChange={e => setForm({...form, nom: e.target.value})} className="border p-2 rounded" />
                                <input placeholder="Prénom" value={form.prenom} onChange={e => setForm({...form, prenom: e.target.value})} className="border p-2 rounded" />
                                <input type="number" placeholder="Poste" value={form.poste} onChange={e => setForm({...form, poste: e.target.value})} className="border p-2 rounded" />
                                <button onClick={() => { if(addFisherman(form.nom, form.prenom, form.poste)) setForm({nom:'', prenom:'', poste:''}) }} className="bg-blue-600 text-white font-bold p-2 rounded">Ajouter</button>
                            </div>
                        </div>
                        <div className="bg-white rounded shadow">
                            {fishermen.map((f, i) => (
                                <div key={i} className="p-4 border-b flex justify-between items-center">
                                    <span>Poste {f.poste} : <b>{f.nom} {f.prenom}</b></span>
                                    <button onClick={() => deleteFisherman(i)} className="text-red-500">Supprimer</button>
                                </div>
                            ))}
                        </div>
                    </div>
                );
            };

            const PostePage = ({ posteNum }) => {
                const fisherman = fishermen.find(f => f.poste === posteNum);
                const [weight, setWeight] = useState('');
                const [count, setCount] = useState('1');
                const [period, setPeriod] = useState('matin');

                if (!fisherman) return (
                    <div className="p-8 text-center">
                        <button onClick={() => setCurrentPage('index')} className="mb-4">Retour</button>
                        <p>Aucun pêcheur au Poste {posteNum}.</p>
                    </div>
                );

                return (
                    <div className="min-h-screen p-4">
                        <button onClick={() => setCurrentPage('index')} className="mb-4 flex items-center text-blue-600"><Icon name="arrow-left" size={20} className="mr-2" /> Retour</button>
                        <div className="bg-white p-6 rounded-lg shadow">
                            <h1 className="text-2xl font-bold mb-4 text-blue-900">Poste {posteNum} : {fisherman.nom}</h1>
                            <div className="bg-yellow-50 p-4 rounded mb-6 text-center">
                                <div className="text-4xl font-black text-green-600">{getTotalWeight(fisherman).toFixed(3)} kg</div>
                                <div className="text-gray-600">{getTotalFishCount(fisherman)} poissons</div>
                            </div>
                            <div className="flex gap-2 mb-6">
                                <select value={period} onChange={e => setPeriod(e.target.value)} className="border p-2 rounded">
                                    <option value="matin">Matin</option>
                                    <option value="apres-midi">A-M</option>
                                </select>
                                <input type="number" step="0.001" placeholder="Poids" value={weight} onChange={e => setWeight(e.target.value)} className="border p-2 rounded flex-1" />
                                <button onClick={() => { addWeight(posteNum, period, weight, count); setWeight(''); }} className="bg-green-600 text-white px-4 rounded font-bold">OK</button>
                            </div>
                            <div className="space-y-2">
                                {fisherman.weights && fisherman.weights.map((w, i) => (
                                    <div key={i} className="flex justify-between border-b py-2 italic text-sm">
                                        <span>{w.period} : {w.weight.toFixed(3)}kg</span>
                                        <button onClick={() => deleteWeight(posteNum, i)} className="text-red-400">Suppr.</button>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>
                );
            };

            const ResultatsPage = () => {
                const sorted = [...fishermen].sort((a, b) => getTotalWeight(b) - getTotalWeight(a));
                return (
                    <div className="min-h-screen p-4">
                        <button onClick={() => setCurrentPage('index')} className="mb-4 flex items-center text-blue-600"><Icon name="arrow-left" size={20} className="mr-2" /> Retour</button>
                        <h1 className="text-2xl font-bold mb-6 text-center">CLASSEMENT LIVE</h1>
                        <div className="space-y-2">
                            {sorted.map((f, i) => (
                                <div key={i} className="bg-white p-4 rounded-lg shadow flex justify-between items-center border-l-4 border-yellow-500">
                                    <div><span className="font-bold">#{i+1}</span> {f.nom} (P{f.poste})</div>
                                    <div className="font-bold text-green-600">{getTotalWeight(f).toFixed(3)} kg</div>
                                </div>
                            ))}
                        </div>
                    </div>
                );
            };

            const SettingsPage = () => {
                const [t, setT] = useState(contestInfo.title);
                const [d, setD] = useState(contestInfo.date);
                return (
                    <div className="p-4">
                        <button onClick={() => setCurrentPage('index')} className="mb-4 flex items-center text-blue-600"><Icon name="arrow-left" size={20} className="mr-2" /> Retour</button>
                        <div className="bg-white p-6 rounded shadow">
                            <h2 className="text-xl font-bold mb-4">Paramètres</h2>
                            <input className="border p-2 w-full mb-2" value={t} onChange={e => setT(e.target.value)} />
                            <input className="border p-2 w-full mb-4" value={d} onChange={e => setD(e.target.value)} />
                            <button onClick={() => { saveContestInfo({title:t, date:d}); setCurrentPage('index'); }} className="bg-green-600 text-white p-3 w-full rounded font-bold">Enregistrer</button>
                        </div>
                    </div>
                );
            };

            if (currentPage === 'index') return <IndexPage />;
            if (currentPage === 'settings') return <SettingsPage />;
            if (currentPage === 'inscription') return <InscriptionPage />;
            if (currentPage === 'resultats') return <ResultatsPage />;
            if (currentPage.startsWith('poste')) return <PostePage posteNum={currentPage.replace('poste', '')} />;
            return <IndexPage />;
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<FishingContestApp />);
    </script>
</body>
</html>
